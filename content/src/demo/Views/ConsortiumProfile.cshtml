<!--
  Turnstone Biologics Confidential
  
  2018 Turnstone Biologics, Inc.
  All Rights Reserved.
  
  This file is subject to the terms and conditions defined in
  file 'license.txt', which is part of this source code package.
   
  Contributors :
        Turnstone Biologics - General Release
-->


<!-- style sheet references -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />

<!-- javascript inclusions -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
<script src="/js/jquery-mask-as-number.js" type="text/javascript" ></script>
<script src="/js/bootstrap-datetimepicker.js" type="text/javascript" ></script>

<!-- masked numeric class setup -->
<script>
    $('.maskedWholeNumberField').maskAsNumber();			// whole # declaration
    $('.maskedDecimalField').maskAsNumber({decimals: 2});	// decimal # declaration
</script>

<!-- datetime class setup -->
<script type="text/javascript">
    $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd',autoclose: true,todayBtn: true});
</script>             

<script type="text/javascript">
	$( document ).ready(function()
	{
		var action 	= getParam("action");
		var id 		= getParam("consortiumId");
		
	 	if ( action == 'edit' )
			$( '#ConsortiumAssociationDivId' ).show();

		var url, args, parentId, parentUrl, addUrl, deleteUrl, modelUrl;
 

		// if edit, populate form fields		
		if ( action == 'edit' )
		{
			jQuery.ajax(
			{
		  		url: '/Consortium/load?consortiumId=' + id,
		  		dataType: 'json',
	            type: "POST",
	            contentType: "application/json",			  				  		
			}).always(function( data ) 
			{
				console.log( 'load returned ' + JSON.stringify( data ) );
				
				var allControls = document.querySelectorAll("input, select, textArea");

				for(var i=0; i < allControls.length; i++)
				{
					var element = allControls[i];
					var elementName = element.name;
					var val;
					
					var indexes = elementName.split( "." );
					if ( indexes.length == 1 )
						val = data[indexes[0]];
					else if ( indexes.length == 2 )
						val = data[indexes[0]][indexes[1]];

					if ( val !== undefined && element.type )
					{
						if ( element.type === 'checkbox' )
						{
							if ( val == true )
								element.checked = true;
							else
								element.checked = false;
						}
						else if ( element.type === 'select' )
						{
							// select the right option
						}
						element.value = val;
					}
				}
			});
		}
	});
	
	// ************************************************
	// notified when the saving is complete
	// ************************************************
	function doneSavingConsortium()
	{
		document.getElementById("ConsortiumFormStatusDivId").innerHTML = '<span style="color:blue">done saving</span>';
	}
	
	// ************************************************
	// form reset
	// ************************************************
	function resetConsortium()
	{
		document.getElementById("ConsortiumProfileFormId").reset();
	}
	
	// ************************************************
	// makes an ajax call to a Consortium controller
	// to passing the form data as a JSON object to be
	// saved
	// ************************************************
	function saveConsortium()
	{
		$('#ConsortiumFormLoadingDivId').show();

		// need to force the val to be handled by the Boolean type
		$("#ConsortiumProfileFormId input:checkbox").each(function()
		{
    		if ( $(this).is(':checked') == false ) 
    			$(this).val( 'false' );    			
    		else
    			$(this).val('true');
  		});

		var url 		= '/Consortium/save';		
		var parentUrl 	= getParam( "parentUrl" );
		var formData 	= formDataToJson( $('#ConsortiumProfileFormId'));
		var action 		= getParam( "action" );

		console.log( 'parentUrl is ' + parentUrl );
					
		formData = JSON.stringify( formData );
				
		jQuery.ajax(
		{
	  		url: url,
	  		dataType: 'json',
	  		data : formData,
            type: "POST",
            contentType: "application/json",
	  		
		}).always(function( data ) 
		{
			if ( parentUrl != null && parentUrl != 'null' && parentUrl != '' )
			{
				parentUrl = parentUrl + '&childId=' + data['consortiumId'];
				jQuery.ajax(
				{
			  		url: parentUrl,
			  		dataType: 'json',
			  		type: "POST",
		            contentType: "application/json",			  		
				}).always(function( data ) 
				{
				});
			}

/********************* 
   	force a close on create rather than show the children since there are none,\
   	causing an inspection on a freshly created Consortium
   
			// need to assign the related hidden primary key element value to 
			// the new value created during the save
			document.getElementById('consortiumId').value = data['consortiumId'];

			if ( action == 'create' )
				$( '#ConsortiumAssociationDivId' ).show();
***********************/				
			doneSavingConsortium();
		});
		
		$('#ConsortiumFormLoadingDivId').hide();			
	
	}
	// ***************************************************
	// shows the form for a child and forces the creation
	// of the child to be bound with the parent on its
	// roleName
	// ***************************************************
    function addHelperForConsortium( associationClassType, roleName )
	{    
		var title = "Add New " + associationClassType + " for Consortium " + roleName;
		var parentId = document.getElementById("consortiumId").value;
		parentUrl = '/Consortium/save' + roleName + '?consortiumId=' + parentId;
		var url = '/' + associationClassType + '/Profie?action=create&parentUrl=' + parentUrl + '&parentName=consortium&roleName=' + roleName;
		var eventToFire = 'refresh' + roleName + 'ForConsortium';
		inspectionDialog( title, url, eventToFire );
    }

	// ***************************************************
	// upon confirmation, forces a disassociation of 
	// children by id from the parent on it's roleName
	// ***************************************************
	function deleteHelperForConsortium( nameOfRole, keyFieldName, ids )
	{
    	BootstrapDialog.confirm
    	({
        	title: 'WARNING',
        	message: 'Are you sure?',
            type: BootstrapDialog.TYPE_WARNING, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
            closable: true, // <-- Default value is false
            btnCancelLabel: 'No', // <-- Default value is 'Cancel',
            btnOKLabel: 'Yes', // <-- Default value is 'OK',
            btnOKClass: 'btn-warning', // <-- If you didn't specify it, dialog type will be used,
            callback: function(result) 
            {
				var elementName = nameOfRole.toLowerCase() + "." + keyFieldName;
				var element 	= document.getElementsByName(elementName)[0];
				var url 		= '/Consortium/delete' + nameOfRole;
				
				url = url + '?childIds=' + ids;
				
				jQuery.ajax(
				{
			  		url: url,
			  		dataType: 'text',
			  		data : $('#ConsortiumProfileFormId').serialize(),			  		
				}).always(function( data ) 
				{
					document.getElementById("ConsortiumFormStatusDivId").innerHTML = '<span style="color:blue">done deleting</span>';
					element.value = ""; // clear it
				});
			}
    	});
	
	}
</script>

<div id="ConsortiumProfileFormDiv" style="padding:4px;border:2px solid lightgray">
  <form id="ConsortiumProfileFormId" class="formTableClass">
    <!-- default to 0 is important to indicate an unassigned key to the Controller layer -->
    <input type=hidden id="consortiumId" name="consortiumId" value="0"/>  		  	
<!-- Direct Attributes -->          	
<table class="formTableClass">
</table>

<!-- Next, output the composites from single associations as fields -->          	
    <table class="formTableClass">
    </table>
  	<br>
	<div>
		<a href="#" data-toggle="tooltip" data-placement="below" title="save Consortium" onclick="saveConsortium()">
		    <button type="button" class="btn btn-default btn-sm">
		      <span class="glyphicon glyphicon-floppy-disk">
		      	Save
		      </span>
			</button>
		</a>
		<a href="#" data-toggle="tooltip" data-placement="below" title="reset" onclick="resetConsortium()">
		    <button type="button" class="btn btn-default btn-sm">
		      <span class="glyphicon glyphicon-refresh">
		      	Reset
		      </span>
			</button>
		</a>
	</div> 
  </form>
</div>

<!-- Next, output the single associations -->

<div id="ConsortiumAssociationDivId" style="display:none">
  <div class="singleAssociationClass">
    <table class="associationTableClass">
	</table>
  </div>

  <!-- finally, output the multiple associations -->
  
  <div "class=multipleAssociationClass">  
	<table class="associationTableClass">  
	</table>

  </div>
</div>
<div id="ConsortiumFormLoadingDivId" style="display:none;color:black">
  saving Consortium...<image src="../img/load_new.gif" width=48 height=48/>
</div>				  				  
<div id="ConsortiumFormStatusDivId">
</div>				  				  


