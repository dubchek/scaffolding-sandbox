<!--
  Turnstone Biologics Confidential
  
  2018 Turnstone Biologics, Inc.
  All Rights Reserved.
  
  This file is subject to the terms and conditions defined in
  file 'license.txt', which is part of this source code package.
   
  Contributors :
        Turnstone Biologics - General Release
-->


<!-- style sheet references -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />

<!-- javascript inclusions -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
<script src="/js/jquery-mask-as-number.js" type="text/javascript" ></script>
<script src="/js/bootstrap-datetimepicker.js" type="text/javascript" ></script>

<!-- masked numeric class setup -->
<script>
    $('.maskedWholeNumberField').maskAsNumber();			// whole # declaration
    $('.maskedDecimalField').maskAsNumber({decimals: 2});	// decimal # declaration
</script>

<!-- datetime class setup -->
<script type="text/javascript">
    $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd',autoclose: true,todayBtn: true});
</script>             

<script type="text/javascript">
	$( document ).ready(function()
	{
		var action 	= getParam("action");
		var id 		= getParam("clientId");
		
	 	if ( action == 'edit' )
			$( '#ClientAssociationDivId' ).show();

		var url, args, parentId, parentUrl, addUrl, deleteUrl, modelUrl;
 

		// if edit, populate form fields		
		if ( action == 'edit' )
		{
			jQuery.ajax(
			{
		  		url: '/Client/load?clientId=' + id,
		  		dataType: 'json',
	            type: "POST",
	            contentType: "application/json",			  				  		
			}).always(function( data ) 
			{
				console.log( 'load returned ' + JSON.stringify( data ) );
				
				var allControls = document.querySelectorAll("input, select, textArea");

				for(var i=0; i < allControls.length; i++)
				{
					var element = allControls[i];
					var elementName = element.name;
					var val;
					
					var indexes = elementName.split( "." );
					if ( indexes.length == 1 )
						val = data[indexes[0]];
					else if ( indexes.length == 2 )
						val = data[indexes[0]][indexes[1]];

					if ( val !== undefined && element.type )
					{
						if ( element.type === 'checkbox' )
						{
							if ( val == true )
								element.checked = true;
							else
								element.checked = false;
						}
						else if ( element.type === 'select' )
						{
							// select the right option
						}
						element.value = val;
					}
				}
			});
		}
	});
	
	// ************************************************
	// notified when the saving is complete
	// ************************************************
	function doneSavingClient()
	{
		document.getElementById("ClientFormStatusDivId").innerHTML = '<span style="color:blue">done saving</span>';
	}
	
	// ************************************************
	// form reset
	// ************************************************
	function resetClient()
	{
		document.getElementById("ClientProfileFormId").reset();
	}
	
	// ************************************************
	// makes an ajax call to a Client controller
	// to passing the form data as a JSON object to be
	// saved
	// ************************************************
	function saveClient()
	{
		$('#ClientFormLoadingDivId').show();

		// need to force the val to be handled by the Boolean type
		$("#ClientProfileFormId input:checkbox").each(function()
		{
    		if ( $(this).is(':checked') == false ) 
    			$(this).val( 'false' );    			
    		else
    			$(this).val('true');
  		});

		var url 		= '/Client/save';		
		var parentUrl 	= getParam( "parentUrl" );
		var formData 	= formDataToJson( $('#ClientProfileFormId'));
		var action 		= getParam( "action" );

		console.log( 'parentUrl is ' + parentUrl );
					
		formData = JSON.stringify( formData );
				
		jQuery.ajax(
		{
	  		url: url,
	  		dataType: 'json',
	  		data : formData,
            type: "POST",
            contentType: "application/json",
	  		
		}).always(function( data ) 
		{
			if ( parentUrl != null && parentUrl != 'null' && parentUrl != '' )
			{
				parentUrl = parentUrl + '&childId=' + data['clientId'];
				jQuery.ajax(
				{
			  		url: parentUrl,
			  		dataType: 'json',
			  		type: "POST",
		            contentType: "application/json",			  		
				}).always(function( data ) 
				{
				});
			}

/********************* 
   	force a close on create rather than show the children since there are none,\
   	causing an inspection on a freshly created Client
   
			// need to assign the related hidden primary key element value to 
			// the new value created during the save
			document.getElementById('clientId').value = data['clientId'];

			if ( action == 'create' )
				$( '#ClientAssociationDivId' ).show();
***********************/				
			doneSavingClient();
		});
		
		$('#ClientFormLoadingDivId').hide();			
	
	}
	// ***************************************************
	// shows the form for a child and forces the creation
	// of the child to be bound with the parent on its
	// roleName
	// ***************************************************
    function addHelperForClient( associationClassType, roleName )
	{    
		var title = "Add New " + associationClassType + " for Client " + roleName;
		var parentId = document.getElementById("clientId").value;
		parentUrl = '/Client/save' + roleName + '?clientId=' + parentId;
		var url = '/' + associationClassType + '/Profie?action=create&parentUrl=' + parentUrl + '&parentName=client&roleName=' + roleName;
		var eventToFire = 'refresh' + roleName + 'ForClient';
		inspectionDialog( title, url, eventToFire );
    }

	// ***************************************************
	// upon confirmation, forces a disassociation of 
	// children by id from the parent on it's roleName
	// ***************************************************
	function deleteHelperForClient( nameOfRole, keyFieldName, ids )
	{
    	BootstrapDialog.confirm
    	({
        	title: 'WARNING',
        	message: 'Are you sure?',
            type: BootstrapDialog.TYPE_WARNING, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
            closable: true, // <-- Default value is false
            btnCancelLabel: 'No', // <-- Default value is 'Cancel',
            btnOKLabel: 'Yes', // <-- Default value is 'OK',
            btnOKClass: 'btn-warning', // <-- If you didn't specify it, dialog type will be used,
            callback: function(result) 
            {
				var elementName = nameOfRole.toLowerCase() + "." + keyFieldName;
				var element 	= document.getElementsByName(elementName)[0];
				var url 		= '/Client/delete' + nameOfRole;
				
				url = url + '?childIds=' + ids;
				
				jQuery.ajax(
				{
			  		url: url,
			  		dataType: 'text',
			  		data : $('#ClientProfileFormId').serialize(),			  		
				}).always(function( data ) 
				{
					document.getElementById("ClientFormStatusDivId").innerHTML = '<span style="color:blue">done deleting</span>';
					element.value = ""; // clear it
				});
			}
    	});
	
	}
</script>

<div id="ClientProfileFormDiv" style="padding:4px;border:2px solid lightgray">
  <form id="ClientProfileFormId" class="formTableClass">
    <!-- default to 0 is important to indicate an unassigned key to the Controller layer -->
    <input type=hidden id="clientId" name="clientId" value="0"/>  		  	
<!-- Direct Attributes -->          	
<table class="formTableClass">
	<tr class="formTRClass">
	  <td class="formTDClass">id</td>
	  <td class="formTDClass">	<input type='text' id="id" name="id" placeHolder="id" required="" validate="" class="form-control" />	
	</td>
	</tr>
	<tr class="formTRClass">
	  <td class="formTDClass">name</td>
	  <td class="formTDClass">	<input type='text' id="name" name="name" placeHolder="name" required="" validate="" class="form-control" />	
	</td>
	</tr>
</table>

<!-- Next, output the composites from single associations as fields -->          	
    <table class="formTableClass">
    </table>
  	<br>
	<div>
		<a href="#" data-toggle="tooltip" data-placement="below" title="save Client" onclick="saveClient()">
		    <button type="button" class="btn btn-default btn-sm">
		      <span class="glyphicon glyphicon-floppy-disk">
		      	Save
		      </span>
			</button>
		</a>
		<a href="#" data-toggle="tooltip" data-placement="below" title="reset" onclick="resetClient()">
		    <button type="button" class="btn btn-default btn-sm">
		      <span class="glyphicon glyphicon-refresh">
		      	Reset
		      </span>
			</button>
		</a>
	</div> 
  </form>
</div>

<!-- Next, output the single associations -->

<div id="ClientAssociationDivId" style="display:none">
  <div class="singleAssociationClass">
    <table class="associationTableClass">
	</table>
  </div>

  <!-- finally, output the multiple associations -->
  
  <div "class=multipleAssociationClass">  
	<table class="associationTableClass">  
	</table>

  </div>
</div>
<div id="ClientFormLoadingDivId" style="display:none;color:black">
  saving Client...<image src="../img/load_new.gif" width=48 height=48/>
</div>				  				  
<div id="ClientFormStatusDivId">
</div>				  				  


