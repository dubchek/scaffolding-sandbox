<!--
  Turnstone Biologics Confidential
  
  2018 Turnstone Biologics, Inc.
  All Rights Reserved.
  
  This file is subject to the terms and conditions defined in
  file 'license.txt', which is part of this source code package.
   
  Contributors :
        Turnstone Biologics - General Release
-->


<!-- style sheet references -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />

<!-- javascript inclusions -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
<script src="/js/jquery-mask-as-number.js" type="text/javascript" ></script>
<script src="/js/bootstrap-datetimepicker.js" type="text/javascript" ></script>

<!-- masked numeric class setup -->
<script>
    $('.maskedWholeNumberField').maskAsNumber();			// whole # declaration
    $('.maskedDecimalField').maskAsNumber({decimals: 2});	// decimal # declaration
</script>

<!-- datetime class setup -->
<script type="text/javascript">
    $(".form_datetime").datetimepicker({format: 'yyyy-mm-dd',autoclose: true,todayBtn: true});
</script>             

<script type="text/javascript">
	$( document ).ready(function()
	{
		var action 	= getParam("action");
		var id 		= getParam("accountId");
		
	 	if ( action == 'edit' )
			$( '#AccountAssociationDivId' ).show();

		var url, args, parentId, parentUrl, addUrl, deleteUrl, modelUrl;
 

		// if edit, populate form fields		
		if ( action == 'edit' )
		{
			jQuery.ajax(
			{
		  		url: '/Account/load?accountId=' + id,
		  		dataType: 'json',
	            type: "POST",
	            contentType: "application/json",			  				  		
			}).always(function( data ) 
			{
				console.log( 'load returned ' + JSON.stringify( data ) );
				
				var allControls = document.querySelectorAll("input, select, textArea");

				for(var i=0; i < allControls.length; i++)
				{
					var element = allControls[i];
					var elementName = element.name;
					var val;
					
					var indexes = elementName.split( "." );
					if ( indexes.length == 1 )
						val = data[indexes[0]];
					else if ( indexes.length == 2 )
						val = data[indexes[0]][indexes[1]];

					if ( val !== undefined && element.type )
					{
						if ( element.type === 'checkbox' )
						{
							if ( val == true )
								element.checked = true;
							else
								element.checked = false;
						}
						else if ( element.type === 'select' )
						{
							// select the right option
						}
						element.value = val;
					}
				}
			});
		}
	});
	
	// ************************************************
	// notified when the saving is complete
	// ************************************************
	function doneSavingAccount()
	{
		document.getElementById("AccountFormStatusDivId").innerHTML = '<span style="color:blue">done saving</span>';
	}
	
	// ************************************************
	// form reset
	// ************************************************
	function resetAccount()
	{
		document.getElementById("AccountProfileFormId").reset();
	}
	
	// ************************************************
	// makes an ajax call to a Account controller
	// to passing the form data as a JSON object to be
	// saved
	// ************************************************
	function saveAccount()
	{
		$('#AccountFormLoadingDivId').show();

		// need to force the val to be handled by the Boolean type
		$("#AccountProfileFormId input:checkbox").each(function()
		{
    		if ( $(this).is(':checked') == false ) 
    			$(this).val( 'false' );    			
    		else
    			$(this).val('true');
  		});

		var url 		= '/Account/save';		
		var parentUrl 	= getParam( "parentUrl" );
		var formData 	= formDataToJson( $('#AccountProfileFormId'));
		var action 		= getParam( "action" );

		console.log( 'parentUrl is ' + parentUrl );
					
		formData = JSON.stringify( formData );
				
		jQuery.ajax(
		{
	  		url: url,
	  		dataType: 'json',
	  		data : formData,
            type: "POST",
            contentType: "application/json",
	  		
		}).always(function( data ) 
		{
			if ( parentUrl != null && parentUrl != 'null' && parentUrl != '' )
			{
				parentUrl = parentUrl + '&childId=' + data['accountId'];
				jQuery.ajax(
				{
			  		url: parentUrl,
			  		dataType: 'json',
			  		type: "POST",
		            contentType: "application/json",			  		
				}).always(function( data ) 
				{
				});
			}

/********************* 
   	force a close on create rather than show the children since there are none,\
   	causing an inspection on a freshly created Account
   
			// need to assign the related hidden primary key element value to 
			// the new value created during the save
			document.getElementById('accountId').value = data['accountId'];

			if ( action == 'create' )
				$( '#AccountAssociationDivId' ).show();
***********************/				
			doneSavingAccount();
		});
		
		$('#AccountFormLoadingDivId').hide();			
	
	}
	// ***************************************************
	// shows the form for a child and forces the creation
	// of the child to be bound with the parent on its
	// roleName
	// ***************************************************
    function addHelperForAccount( associationClassType, roleName )
	{    
		var title = "Add New " + associationClassType + " for Account " + roleName;
		var parentId = document.getElementById("accountId").value;
		parentUrl = '/Account/save' + roleName + '?accountId=' + parentId;
		var url = '/' + associationClassType + '/Profie?action=create&parentUrl=' + parentUrl + '&parentName=account&roleName=' + roleName;
		var eventToFire = 'refresh' + roleName + 'ForAccount';
		inspectionDialog( title, url, eventToFire );
    }

	// ***************************************************
	// upon confirmation, forces a disassociation of 
	// children by id from the parent on it's roleName
	// ***************************************************
	function deleteHelperForAccount( nameOfRole, keyFieldName, ids )
	{
    	BootstrapDialog.confirm
    	({
        	title: 'WARNING',
        	message: 'Are you sure?',
            type: BootstrapDialog.TYPE_WARNING, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
            closable: true, // <-- Default value is false
            btnCancelLabel: 'No', // <-- Default value is 'Cancel',
            btnOKLabel: 'Yes', // <-- Default value is 'OK',
            btnOKClass: 'btn-warning', // <-- If you didn't specify it, dialog type will be used,
            callback: function(result) 
            {
				var elementName = nameOfRole.toLowerCase() + "." + keyFieldName;
				var element 	= document.getElementsByName(elementName)[0];
				var url 		= '/Account/delete' + nameOfRole;
				
				url = url + '?childIds=' + ids;
				
				jQuery.ajax(
				{
			  		url: url,
			  		dataType: 'text',
			  		data : $('#AccountProfileFormId').serialize(),			  		
				}).always(function( data ) 
				{
					document.getElementById("AccountFormStatusDivId").innerHTML = '<span style="color:blue">done deleting</span>';
					element.value = ""; // clear it
				});
			}
    	});
	
	}
</script>

<div id="AccountProfileFormDiv" style="padding:4px;border:2px solid lightgray">
  <form id="AccountProfileFormId" class="formTableClass">
    <!-- default to 0 is important to indicate an unassigned key to the Controller layer -->
    <input type=hidden id="accountId" name="accountId" value="0"/>  		  	
<!-- Direct Attributes -->          	
<table class="formTableClass">
	<tr class="formTRClass">
	  <td class="formTDClass">id</td>
	  <td class="formTDClass">	<input type='text' id="id" name="id" placeHolder="id" required="" validate="" class="form-control" />	
	</td>
	</tr>
	<tr class="formTRClass">
	  <td class="formTDClass">amount</td>
	  <td class="formTDClass">	<input type='text' id="amount" name="amount" placeHolder="amount" required="" validate="" class="form-control" />	
	</td>
	</tr>
	<tr class="formTRClass">
	  <td class="formTDClass">currency</td>
	  <td class="formTDClass">	<input type='text' id="currency" name="currency" placeHolder="currency" required="" validate="" class="form-control" />	
	</td>
	</tr>
</table>

<!-- Next, output the composites from single associations as fields -->          	
    <table class="formTableClass">
    </table>
  	<br>
	<div>
		<a href="#" data-toggle="tooltip" data-placement="below" title="save Account" onclick="saveAccount()">
		    <button type="button" class="btn btn-default btn-sm">
		      <span class="glyphicon glyphicon-floppy-disk">
		      	Save
		      </span>
			</button>
		</a>
		<a href="#" data-toggle="tooltip" data-placement="below" title="reset" onclick="resetAccount()">
		    <button type="button" class="btn btn-default btn-sm">
		      <span class="glyphicon glyphicon-refresh">
		      	Reset
		      </span>
			</button>
		</a>
	</div> 
  </form>
</div>

<!-- Next, output the single associations -->

<div id="AccountAssociationDivId" style="display:none">
  <div class="singleAssociationClass">
    <table class="associationTableClass">
	</table>
  </div>

  <!-- finally, output the multiple associations -->
  
  <div "class=multipleAssociationClass">  
	<table class="associationTableClass">  
	</table>

  </div>
</div>
<div id="AccountFormLoadingDivId" style="display:none;color:black">
  saving Account...<image src="../img/load_new.gif" width=48 height=48/>
</div>				  				  
<div id="AccountFormStatusDivId">
</div>				  				  


